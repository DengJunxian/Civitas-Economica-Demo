# 数治观澜 (Civitas Economica) —— 金融政策风洞推演沙箱

![License](https://img.shields.io/badge/license-MIT-blue.svg)
![Python](https://img.shields.io/badge/python-3.9%2B-blue)
![Streamlit](https://img.shields.io/badge/Streamlit-1.30%2B-FF4B4B)
![Mesa](https://img.shields.io/badge/Mesa-3.0%2B-green)

**数治观澜**（Civitas A股政策仿真平台）是一个基于大模型（LLM）多智能体（Multi-Agent）与微观市场引擎（Mesa/C++ LOB）构建的金融政策风洞推演沙箱。本系统旨在模拟、测试和评估各项宏观调控与金融监管政策在复杂市场环境下的传导路径与长效影响。

通过结合行为金融学与社会网络传染模型，系统能够在“政策发布 -> 智能体认知/辩论 -> 情绪传染 -> 交易策略 -> 市场微观结构反身性”的完整链条上进行推演，帮助决策者“防患于未然”。

---

## 🌟 核心功能模块与使用说明

启动系统后，在左侧边栏可进行**API配置**、**模式选择**及**政策注入**。主界面分为多个核心功能控制面板（Tab页）。

### 1. 🌪️ 沙箱风洞 (Sandbox Wind Tunnel)
**主要功能**：以直观的“三阶段连贯推演”形式，为外部观察者和汇报展示提供一套标准的政策压力测试流程。
- **使用方式**：点击进入页面后，依次触发“政策注入与博弈”、“情绪传染网络”及“订单簿冲击与熔断”，直观查看大模型智能体如何从理解政策走向市场踩踏或狂热。

### 2. 📈 市场走势 (Market Trend)
**主要功能**：实盘级的仿真行情监控。
- **使用方式**：
  - 实时查看看板上方的**上证指数**点位、涨跌幅、**恐慌指数**等宏观指标。
  - 通过图表选择区域，支持切换 日K / 周K / 月K 视图，实时追踪智能体每一天交易形成的市场K线走势。

### 3. 🧠 Agent fMRI (认知透镜)
**主要功能**：打开大模型智能体的“黑盒”，可视化其思维链（Chain of Thought）与情绪变化。
- **使用方式**：
  - 在列表中点击任意活跃的智能体（如：散户、游资、机构）。
  - 查看其当前的**行为偏好 (Behavioral Profile)**、**长短期记忆 (Memory retrieval)**、**情绪刻度碑 (Greed/Fear)** 及其每一步决策的**内部深度推理过程**。

### 4. ⚔️ 辩论室 (DeepSeek 多空辩论厅)
**主要功能**：防幻觉的机制设计，通过多主体多空博弈，消解单一AI模型的顺从性幻觉。
- **使用方式**：
  - 当你在左侧边栏输入新政策并点击“分析政策”后，切入此大厅。
  - 你将看到系统派生的多名专家Agent（多头代表 vs 空头代表）对该政策可能导致的市场结果进行多轮唇枪舌剑的推演，最终汇总出一个具有共识度（或极度分化）的综合政策预期。

### 5. 🏛️ 监管沙盒 (Regulatory Sandbox)
**主要功能**：动态干预系统，充当“上帝之手”。
- **使用方式**：
  - 遇到市场极端行情时，在这个模块手动介入；
  - 调整**交易印花税**（从千分之一降至万分之五）、触发**国家队救市 (平准基金)**、调整**熔断阈值**或约束**程序化交易（量化限空）**，观察市场引擎对监管介入的即刻反应。

### 6. 📊 行为金融 (Behavioral Finance)
**主要功能**：监测市场情绪在社交网络（图拓扑结构）上的传染情况与群体趋同度。
- **使用方式**：
  - 加载**实时社交网络拓扑图**（Network Graph），观察代表恐慌的红色节点如何通过“大V”或核心机构传染至普通散户。
  - 观察 CSAD（横截面绝对收益离差）指标，研判当前市场是否进入了典型的“散户羊群效应（Herding）”发作期。

### 7. 🤖 量化群体 (Quantitative Groups)
**主要功能**：引入非LLM的高频、系统性交易者，观察机器算法与AI/人类行为的互动。
- **使用方式**：
  - 在侧边栏扩展设置中，可以选择快速向市场注入批量基于算法的**量化群体**（如：动量追踪、均值回归、风险平价、消息驱动）。
  - 在本Tab页监控各个群体的收益率曲线及持仓暴露，检视行情暴跌时量化策略是否构成主要抛压。

---

## 🚀 快速启动与安装

### 1. 环境准备
确保您的计算机上已安装 Python 3.9+ 环境，同时由于含有C++底层订单簿引擎(`_civitas_lob.cp314-win_amd64.pyd`)，请确保环境运行在对应的系统架构下（Windows amd64）。

```bash
# 建议使用虚拟环境
python -m venv venv
# 激活环境
# Windows:
.\venv\Scripts\activate
# macOS/Linux (若你有自行编译的.so扩展):
source venv/bin/activate
```

### 2. 安装依赖
```bash
pip install -r requirements.txt
```
*(如遇编译订单簿缺失的问题，请确保系统具有基础的 C++ Build Tools 以处理 pybind11 安装 或直接使用项目中预编译的 pyd)*

### 3. 配置密钥 (API Keys)
系统强依赖大模型 API 进行 Agent 的逻辑推演。
- 你可以复制 `config.yaml` 或在运行时根据命令行/左侧边栏界面输入你的 API Keys。
- 目前首推 **DeepSeek API**（`deepseek-chat` / `deepseek-reasoner`）及 **智谱 GLM API**（`glm-4-flashx`）。

### 4. 启动应用
您可以直接运行根目录下的执行脚本启动可视化应用：

```bash
python main.py
```
*(脚本会自动检查依赖、API Key并在浏览器中启动 Streamlit 控制台。)*

或者手动运行 streamlit：
```bash
streamlit run app.py
```

---

## ⚙️ 进阶操作指南

### 运行模式说明
在左侧边栏可以切换系统的运行底座：
- **🧠 智能模式 (Smart)**: 默认模式。深度模型与极速模型混用，在推理深度与耗时(≤15s/天)间取平衡。
- **⚡ 快速模式 (Fast)**: 全部走小型/闪电对话模型(≤5s)，适合设备带宽不高或调试时快速走完日程表。
- **🔬 深度模式 (Deep)**: Agent 全量使用复杂思维链进行慢思考(≤30s/天)，适合用于生成严肃的研究报告数据。

### 历史回测 vs 实时仿真
- 当选择 **实时仿真** 时，市场从第一天开始进行完全由多智能体互动走出的演化行情。
- 当选择 **历史回测** 时，系统会注入真实大盘历史连续数据（如近3年上证），将重点锚定于“校准Agent的反应逻辑与微观指标”。

### 一键生成报告
在经过一段天数的仿真推演后，您可以暂停模拟，并点击左下角的 **📑 生成报告** 按钮。系统会调用推理模型梳理这期间的各项市场指标（走势、恐慌度、CSAD）及您注入的政策，生成一份五百字左右具备专业投研深度的《金融政策效果评估报告》。

---

## 📁 核心架构及目录说明

- `/app.py & /main.py`：UI前端呈现及主程序入口处。
- `/core`：核心运行引擎
  - `/mesa/civitas_model.py`：MESA 环境定义，调度 Agent。
  - `/exchange/order_book.py`：微观市场撮合引擎，含高频限价指令簿支持。
  - `/market_engine.py` & `/regulatory_sandbox.py`：市场价格计算与监管接口宏定义。
- `/agents`：智能体定义
  - `brain.py`：大模型对话逻辑和认知状态机。
  - `debate_brain.py` & `reflection.py`：多空辩论代理与深层反思模块。
  - `quant_group.py`：非LLM算法交易机器人。
- `/ui`：风洞控制及其他渲染组件。
- `/data`：存放用于回测或校准的历史数据。
- `/tests`：自动化单元与机制拦截测试。

---

*“让政策风险暴露在沙盒中，让真实增长降临在市场上。”*
